<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>genedots.</title>
    <!-- https://getbootstrap.jp/docs/5.0/getting-started/introduction/ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- https://d3js.org/getting-started -->
<script type="module">
import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

const data = {
  genes: await d3.json("./genedots.json"),
  position_max: { x: 250000000, y: 25 },
  homolog_max: { x: 7000, y: 22 },
  width: 2000,
  height: 1000,
  margin: { left: 20, right: 20, top: 20, bottom: 20 }
}

const canvas = {
  left: data.margin.left,
  right: data.width - data.margin.right,
  top: data.margin.top,
  bottom: data.height - data.margin.bottom
}

const tool = {
  scale_x: {
    position: d3.scaleLinear().range([canvas.left, canvas.right]).domain([1, data.position_max.x])
  },
  scale_y: {
    position: d3.scaleLinear().range([canvas.top, canvas.bottom]).domain([1, data.position_max.y])
  },
  scale_z: {
    linear: d3.scaleLinear().range([1, 10]).domain(d3.extent(data.genes, d => d.len)),
    log: d3.scaleLog().range([1, 10]).domain(d3.extent(data.genes, d => d.len)),
    clinvar: d3.scaleLinear().range([1, 20]).domain(d3.extent(data.genes, d => d.clinvar)),
    disease: d3.scaleLinear().range([1, 20]).domain(d3.extent(data.genes, d => d.disease)),
    ppi: d3.scaleLinear().range([1, 20]).domain(d3.extent(data.genes, d => d.ppi)),
    paralog: d3.scaleLinear().range([1, 10]).domain(d3.extent(data.genes, d => d.paralog)),
    homolog: d3.scaleLinear().range([1, 8]).domain(d3.extent(data.genes, d => d.homolog))
  },
  palette: d3.scaleOrdinal(d3.schemeTableau10)
}
//tool.scale_z = tool.scale_z_lin

const svg = d3.select("svg#canvas")
  .attr("width", data.width)
  .attr("height", data.height)

svg.append("g")
/*
  .attr("toggle_color", "strand")
  .attr("toggle_size", "length")
  .attr("toggle_scale", "linear")
*/
  .attr("toggle_clinvar", "default")
  .attr("toggle_disease", "default")
  .attr("toggle_ppi", "default")
  .attr("toggle_homolog", "default")
  .attr("toggle_paralog", "default")
  .selectAll("circle")
  .data(data.genes)
  .join("circle")
  .attr("class", d => d.hgnc)
  .classed("forward", d => d.str > 0)
  .classed("reverse", d => d.str < 0)
  .attr("cx", d => tool.scale_x.position(d.pos))
  .attr("cy", d => tool.scale_y.position(d.chr_sort))
  .attr("r", d => tool.scale_z.linear(d.len))
  .style("fill", d => tool.palette(d.band))
  .on("mouseover", d => infobox(d.target.__data__))
  .on("click", d => console.log(d.target.__data__))

/*
d3.select("#toggle_color").on("click", toggle_color)
d3.select("#toggle_size").on("click", toggle_size)
d3.select("#toggle_scale").on("click", toggle_scale)
*/
/*
d3.select("#toggle_clinvar").on("click", toggle("clinvar"))
d3.select("#toggle_disease").on("click", toggle("disease"))
d3.select("#toggle_ppi").on("click", toggle("ppi"))
d3.select("#toggle_homolog").on("click", toggle("homolog"))
d3.select("#toggle_paralog").on("click", toggle("paralog"))
*/
d3.select("#toggle_clinvar").on("click", toggle_clinvar)
d3.select("#toggle_disease").on("click", toggle_disease)
d3.select("#toggle_ppi").on("click", toggle_ppi)
d3.select("#toggle_homolog").on("click", toggle_homolog)
d3.select("#toggle_paralog").on("click", toggle_paralog)

d3.select("#infobox_hgnc").on("click", d => window.open("http://identifiers.org/" + d.target.parentNode.attributes["hgnc_id"].nodeValue, '_blank'))
d3.select("#infobox_ensg").on("click", d => window.open("http://identifiers.org/ensembl/" + d.target.textContent, "_blank"))
d3.select("#infobox_up").on("click", d => window.open("http://identifiers.org/uniprot/" + d.target.textContent, "_blank"))

d3.select("#search_hgnc").on("input", search_hgnc)

function search_hgnc() {
  let hgnc = d3.select("#search_hgnc").property("value");
  if (hgnc.length >= 2) {
    console.log(hgnc)
    d3.selectAll("circle")
      .filter(function() {
        return ! d3.select(this).classed("highlight")
      })
      .style("opacity", 0.3)
      .filter(function() {
        return d3.select(this).classed(hgnc)
      })
      .style("opacity", 1)
      .classed("highlight", true)
  }
}

function infobox(d) {
  d3.select("#infobox_hgnc").attr("hgnc_id", d.hgnc_id)
  d3.select("#info_gene").text(d.hgnc)
  d3.select("#info_hgnc").text(d.hgnc_id)
  d3.select("#info_chr").text(d.chr)
  d3.select("#info_pos").text(d.pos)
  d3.select("#info_len").text(d.len)
  d3.select("#info_ensg").text(d.ensg)
  d3.select("#info_up").text(d.up)
}

function toggle_clinvar() {
  toggle("clinvar")
}
function toggle_disease() {
  toggle("disease")
}
function toggle_ppi() {
  toggle("ppi")
}
function toggle_homolog() {
  toggle("homolog")
}
function toggle_paralog() {
  toggle("paralog")
}

function toggle(attr) {
  let graphic = d3.select("svg#canvas").select("g")
  switch ( graphic.attr("toggle_" + attr) ) {
    case "activated":
      toggle_default(attr)
      break
    default:
      toggle_activate(attr)
  }
}

function toggle_default(attr) {
  let graphic = d3.select("svg#canvas").select("g")
  let circles = d3.selectAll("circle")
  circles.attr("r", d => tool.scale_z.linear(d.len))
  circles.style("fill", d => tool.palette(d.band))
  circles.style("opacity", 1)
  graphic.attr("toggle_" + attr, "default")
}

function toggle_activate(attr) {
  let graphic = d3.select("svg#canvas").select("g")
  let circles = d3.selectAll("circle")
  let scale_z = tool.scale_z[attr]
  circles.attr("r", d => scale_z(d[attr]))
  if (attr == "clinvar") {
    circles.style("fill", d => d.pathogenic ? "#d1605e" : "#5878a3")
  }
  circles.style("opacity", 0.7)
  graphic.attr("toggle_" + attr, "activated")
}

/*
function toggle_clinvar() {
  let graphic = d3.select("svg#canvas").select("g")
  let circles = d3.selectAll("circle")
  switch ( graphic.attr("toggle_clinvar") ) {
    case "length":
      circles.attr("r", d => tool.scale_z.clinvar(d.clinvar))
      circles.style("opacity", 0.9)
      graphic.attr("toggle_clinvar", "clinvar")
      break
    case "clinvar":
      circles.attr("r", d => tool.scale_z.linear(d.len))
      circles.style("fill", d => tool.palette(d.band))
      circles.style("opacity", 1)
      graphic.attr("toggle_clinvar", "length")
      break
  }
}
*/

/*
function toggle_color() {
  let graphic = d3.select("svg#canvas").select("g")
  let circles = d3.selectAll("circle")
  switch ( graphic.attr("toggle_color") ) {
    case "strand":
      circles.style("fill", d => tool.palette(d.band))
      graphic.attr("toggle_color", "band")
      break
    case "band":
      circles.style("fill", d => tool.palette(d.str))
      graphic.attr("toggle_color", "strand")
      break
  }
}

function toggle_size() {
  let graphic = d3.select("svg#canvas").select("g")
  let circles = d3.selectAll("circle")
  switch ( graphic.attr("toggle_size") ) {
    case "length":
      circles.attr("r", 5)
      circles.style("opacity", 0.7)
      graphic.attr("toggle_size", "const")
      break
    case "const":
      circles.attr("r", d => tool.scale_z(d.len))
      circles.style("opacity", 1)
      graphic.attr("toggle_size", "length")
      break
  }
}

function toggle_scale() {
  let graphic = d3.select("svg#canvas").select("g")
  let circles = d3.selectAll("circle")
  switch ( graphic.attr("toggle_scale") ) {
    case "linear":
      tool.scale_z = tool.scale_z_log
      circles.attr("r", d => tool.scale_z(d.len))
      circles.style("opacity", 0.7)
      graphic.attr("toggle_scale", "log")
      break
    case "log":
      tool.scale_z = tool.scale_z_lin
      circles.attr("r", d => tool.scale_z(d.len))
      circles.style("opacity", 1)
      graphic.attr("toggle_scale", "linear")
      break
  }
}
*/
</script>

<style>
@import url('https://fonts.googleapis.com/css?family=Ubuntu+Mono');
body {
  font-family: 'Ubuntu Mono', monospace;
}
.canvas {
  padding: 20px;
}
.highlight {
  stroke: black;
  stroke-opacity: 1;
  stroke-width: 10px;
  stroke-dasharray: 1;
}
.forward {
  transform: translateY(-5px);
}
.reverse {
  transform: translateY(5px);
}

/*
.forward {
  animation: forward 3s linear;
}
.reverse {
  animation: reverse 3s linear;
}
@keyframes forward {
  from {
    transform: translateY(0px);
  }
  to {
    transform: translateY(-5px);
  }
}
@keyframes reverse {
  from {
    transform: translateY(0px);
  }
  to {
    transform: translateY(5px);
  }
}
*/
</style>

  </head>
  <body>
    <div class="canvas">
      <h1>genedots.</h1>
      <span class="input-group mb-3">
	<button class="btn btn-secondary" type="button" id="infobox_hgnc">
          <span class="" id="info_gene">Gene</span>
<!--
          <span class="" id="info_hgnc">ID</span>
-->
          <span class="" id="info_chr">Chr</span>:<span class="" id="info_pos">Pos</span>
          (<span class="" id="info_len">Len</span> bp)
        </button>
        <input type="text" class="form-control" id="search_hgnc" placeholder="HGNC" aria-label="HGNC" aria-describedby="basic-addon1">
	<button class="btn btn-secondary" type="button" id="infobox_ensg">
          <span class="" id="info_ensg">Ensembl</span>
	</button>
	<button class="btn btn-secondary" type="button" id="infobox_up">
          <span class="" id="info_up">UniProt</span>
	</button>
<!--
	<button class="btn btn-warning" type="button" id="toggle_color">Color by strand/band</button>
	<button class="btn btn-success" type="button" id="toggle_size">Size by length/const</button>
	<button class="btn btn-primary" type="button" id="toggle_scale">Scale by linear/log</button>
-->
	<button class="btn btn-warning" type="button" id="toggle_clinvar">ClinVar</button>
	<button class="btn btn-danger"  type="button" id="toggle_disease">Disease</button>
	<button class="btn btn-success" type="button" id="toggle_ppi">PPI</button>
	<button class="btn btn-info"    type="button" id="toggle_paralog">Paralog</button>
	<button class="btn btn-primary" type="button" id="toggle_homolog">Homolog</button>
      </span>
      <svg id="canvas"></svg>
    </div>
  </body>
</html>
