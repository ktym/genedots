<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>genedots.</title>
    <!-- https://getbootstrap.jp/docs/5.0/getting-started/introduction/ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- https://d3js.org/getting-started -->
<script type="module">
import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

const data = {
  genes: await d3.json("./genedots.json"),
  domain: {
    position: { x: 250000000, y: 25 },
    clinvar: { x: 20000, y: 700 },
    disease: { x: 20000, y: 50 },
    ppi: { x: 20000, y: 850 },
    paralog: { x: 20000, y: 20 },
    homolog: { x: 20000, y: 22 }
  },
  width: 2000,
  height: 1000,
  margin: { left: 20, right: 20, top: 20, bottom: 20 },
  palette: [
    "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f",
    "#bcbd22", "#17becf", "#393b79", "#637939", "#8c6d31", "#843c39", "#ad494a", "#e7ba52",
    "#8c564b", "#ff9896", "#c5b0d5", "#c49c94", "#f7b6d2", "#dbdb8d", "#9edae5", "#c7c7c7"
  ],
  opacity: 0.9
}

const canvas = {
  left: data.margin.left,
  right: data.width - data.margin.right,
  top: data.margin.top,
  bottom: data.height - data.margin.bottom
}

const tool = {
  scale_x: {
    position: d3.scaleLinear().range([canvas.left, canvas.right]).domain([1, data.domain.position.x]),
    clinvar: d3.scaleLinear().range([canvas.left, canvas.right]).domain([1, data.domain.clinvar.x]),
    disease: d3.scaleLinear().range([canvas.left, canvas.right]).domain([1, data.domain.disease.x]),
    ppi: d3.scaleLinear().range([canvas.left, canvas.right]).domain([1, data.domain.ppi.x]),
    paralog: d3.scaleLinear().range([canvas.left, canvas.right]).domain([1, data.domain.paralog.x]),
    homolog: d3.scaleLinear().range([canvas.left, canvas.right]).domain([1, data.domain.homolog.x])
  },
  scale_y: {
    position: d3.scaleLinear().range([canvas.top, canvas.bottom]).domain([1, data.domain.position.y]),
    clinvar: d3.scaleLinear().range([canvas.top, canvas.bottom]).domain([1, data.domain.clinvar.y]),
    disease: d3.scaleLinear().range([canvas.top, canvas.bottom]).domain([1, data.domain.disease.y]),
    ppi: d3.scaleLinear().range([canvas.top, canvas.bottom]).domain([1, data.domain.ppi.y]),
//    ppi: d3.scaleLog().range([canvas.top, canvas.bottom]).domain([1, data.domain.ppi.y]),
    paralog: d3.scaleLinear().range([canvas.top, canvas.bottom]).domain([1, data.domain.paralog.y]),
    homolog: d3.scaleLinear().range([canvas.top, canvas.bottom]).domain([1, data.domain.homolog.y])
  },
  scale_z: {
    linear: d3.scaleLinear().range([1, 10]).domain(d3.extent(data.genes, d => d.len)),
    log: d3.scaleLog().range([1, 10]).domain(d3.extent(data.genes, d => d.len)),
    clinvar: d3.scaleLinear().range([1, 20]).domain(d3.extent(data.genes, d => d.clinvar)),
    disease: d3.scaleLinear().range([1, 20]).domain(d3.extent(data.genes, d => d.disease)),
    ppi: d3.scaleLinear().range([1, 20]).domain(d3.extent(data.genes, d => d.ppi)),
    paralog: d3.scaleLinear().range([1, 10]).domain(d3.extent(data.genes, d => d.paralog)),
    homolog: d3.scaleLinear().range([1, 5]).domain(d3.extent(data.genes, d => d.homolog))
  },
//  palette: d3.scaleOrdinal(d3.schemeTableau10)
  palette: d3.scaleOrdinal(data.palette)
}

const svg = d3.select("svg#canvas")
  .attr("width", data.width)
  .attr("height", data.height)

svg.append("g")
  .attr("toggle_clinvar", "default")
  .attr("toggle_disease", "default")
  .attr("toggle_ppi", "default")
  .attr("toggle_homolog", "default")
  .attr("toggle_paralog", "default")
  .selectAll("circle")
  .data(data.genes)
  .join("circle")
  .attr("class", d => d.hgnc)
  .classed("forward", d => d.str > 0)
  .classed("reverse", d => d.str < 0)
  .attr("cx", d => tool.scale_x.position(d.pos))
  .attr("cy", d => tool.scale_y.position(d.chr_sort))
  .attr("r", d => tool.scale_z.linear(d.len))
//  .style("fill", d => tool.palette(d.str))
//  .style("fill", d => tool.palette(d.band))
  .style("fill", d => tool.palette(d.chr_sort))
  .style("opacity", data.opacity)
  .on("mouseover", d => infobox(d.target.__data__))
  .on("click", d => console.log(d.target.__data__))

/*
d3.select("#toggle_clinvar").on("click", toggle("clinvar"))
d3.select("#toggle_disease").on("click", toggle("disease"))
d3.select("#toggle_ppi").on("click", toggle("ppi"))
d3.select("#toggle_homolog").on("click", toggle("homolog"))
d3.select("#toggle_paralog").on("click", toggle("paralog"))
*/

d3.select("#toggle_clinvar").on("click", toggle_clinvar)
d3.select("#toggle_disease").on("click", toggle_disease)
d3.select("#toggle_ppi").on("click", toggle_ppi)
d3.select("#toggle_homolog").on("click", toggle_homolog)
d3.select("#toggle_paralog").on("click", toggle_paralog)

d3.select("#infobox_hgnc").on("click", d => window.open("http://identifiers.org/" + d.target.parentNode.attributes["hgnc_id"].nodeValue, '_blank'))
d3.select("#infobox_ensg").on("click", d => window.open("http://identifiers.org/ensembl/" + d.target.textContent, "_blank"))
d3.select("#infobox_up").on("click", d => window.open("http://identifiers.org/uniprot/" + d.target.textContent, "_blank"))

d3.select("#search_hgnc").on("input", search_hgnc)

function search_hgnc() {
  d3.selectAll("circle").classed("highlight", false).style("opacity", data.opacity)
  let hgncs = d3.select("#search_hgnc").property("value").split(/,\s*/)
  hgncs.forEach(hgnc => {
    if (hgnc.length >= 2) {
      console.log(hgnc)
      d3.selectAll("circle")
        .filter(function() {
          return ! d3.select(this).classed("highlight")
        })
        .style("opacity", 0.3)
        .filter(function() {
          return d3.select(this).classed(hgnc)
        })
        .style("opacity", data.opacity)
        .classed("highlight", true)
    }
  })
}

function infobox(d) {
  d3.select("#infobox_hgnc").attr("hgnc_id", d.hgnc_id)
  d3.select("#info_gene").text(d.hgnc)
//  d3.select("#info_hgnc").text(d.hgnc_id)
  d3.select("#info_chr").text(d.chr)
  d3.select("#info_pos").text(d.pos)
  d3.select("#info_len").text(d.len)
  d3.select("#info_ensg").text(d.ensg)
  d3.select("#info_up").text(d.up)
}

function toggle_clinvar() {
  toggle("clinvar")
}
function toggle_disease() {
  toggle("disease")
}
function toggle_ppi() {
  toggle("ppi")
}
function toggle_homolog() {
  toggle("homolog")
}
function toggle_paralog() {
  toggle("paralog")
}

function toggle(attr) {
  let graphic = d3.select("svg#canvas").select("g")
  switch ( graphic.attr("toggle_" + attr) ) {
    case "activated":
      toggle_default(attr)
      break
    default:
      toggle_activate(attr)
  }
}

function toggle_default(attr) {
  let graphic = d3.select("svg#canvas").select("g")
  let circles = d3.selectAll("circle")
  circles
    .classed("forward", d => d.str > 0)
    .classed("reverse", d => d.str < 0)
  circles.transition()
    .duration(1000)
//    .style("fill", d => tool.palette(d.band))
    .style("fill", d => tool.palette(d.chr_sort))
    .attr("r", d => tool.scale_z.linear(d.len))
//    .attr("cx", d => tool.scale_x.position(d.pos))
    .attr("cy", d => tool.scale_y.position(d.chr_sort))
  graphic.attr("toggle_" + attr, "default")
}

function toggle_activate(attr) {
  let graphic = d3.select("svg#canvas").select("g")
  let circles = d3.selectAll("circle")
  let scale_y = tool.scale_y[attr]
  let scale_z = tool.scale_z[attr]
  if (attr == "clinvar") {
    circles.transition()
      .duration(1000)
      .style("fill", d => d.pathogenic ? "#d1605e" : "#5878a3")
      .attr("r", d => scale_z(d[attr]))
  } else {
    circles
      .classed("forward", false)
      .classed("reverse", false)
    circles.transition()
      .duration(1000)
      .attr("cy", d => scale_y(d[attr]))
      .attr("r", d => scale_z(d[attr]))
  }
  graphic.attr("toggle_" + attr, "activated")
}
</script>

<style>
@import url('https://fonts.googleapis.com/css?family=Ubuntu+Mono');
body {
  font-family: 'Ubuntu Mono', monospace;
}
.canvas {
  padding: 20px;
}
.github-icon {
  color: #000000;
}
.highlight {
  stroke: black;
  stroke-opacity: 1;
  stroke-width: 10px;
  stroke-dasharray: 1;
}
.forward {
  transform: translateY(-5px);
}
.reverse {
  transform: translateY(5px);
}
</style>

  </head>
  <body>
    <div class="canvas">
      <div class="d-flex justify-content-between align-items-center">
        <h1>genedots.</h1>
        <a href="https://github.com/ktym/genedots" target="_blank">
          <i class="fab fa-github fa-2x github-icon"></i>
        </a>
      </div>
      <span class="input-group mb-3">
	<button class="btn btn-secondary" type="button" id="infobox_hgnc">
          <span class="" id="info_gene">Gene</span>
<!--
          <span class="" id="info_hgnc">ID</span>
-->
          <span class="" id="info_chr">Chr</span>:<span class="" id="info_pos">Pos</span>
          (<span class="" id="info_len">Len</span> bp)
        </button>
        <input type="text" class="form-control" id="search_hgnc" placeholder="HGNC" aria-label="HGNC" aria-describedby="basic-addon1">
	<button class="btn btn-secondary" type="button" id="infobox_ensg">
          <span class="" id="info_ensg">Ensembl</span>
	</button>
	<button class="btn btn-secondary" type="button" id="infobox_up">
          <span class="" id="info_up">UniProt</span>
	</button>
<!--
	<button class="btn btn-dark"    type="button" id="toggle_position">Position</button>
-->
	<button class="btn btn-warning" type="button" id="toggle_clinvar">ClinVar</button>
	<button class="btn btn-danger"  type="button" id="toggle_disease">Disease</button>
	<button class="btn btn-success" type="button" id="toggle_ppi">PPI</button>
	<button class="btn btn-info"    type="button" id="toggle_paralog">Paralog</button>
	<button class="btn btn-primary" type="button" id="toggle_homolog">Homolog</button>
      </span>
      <svg id="canvas"></svg>
    </div>
  </body>
</html>
